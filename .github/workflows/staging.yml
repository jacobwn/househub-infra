name: Deploy Staging

on:
  workflow_call:
    inputs:
      commit_sha:
        required: true
        type: string
      repository:
        required: true
        type: string
    secrets:
      GHCR_PAT:
        required: true
      STAGING_SSH_KEY:
        required: true
      STAGING_HOST:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}
    steps:
      - name: Checkout househub code
        uses: actions/checkout@v4
        with:
          repository: jacobwn/househub
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Set IMAGE_TAG from commit SHA
        id: set-tag
        run: |
          SHORT_SHA=$(echo ${{ inputs.commit_sha }} | cut -c1-7)
          echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
          echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Build web image
        run: docker build -f ./services/web/Dockerfile.web.prod -t ghcr.io/${{ inputs.repository }}/web:$IMAGE_TAG ./services/web

      - name: Push web image
        run: docker push ghcr.io/${{ inputs.repository }}/web:$IMAGE_TAG

      - name: Build nginx image
        run: docker build -f ./infra/nginx/Dockerfile.nginx.prod -t ghcr.io/${{ inputs.repository }}/nginx:$IMAGE_TAG .

      - name: Push nginx image
        run: docker push ghcr.io/${{ inputs.repository }}/nginx:$IMAGE_TAG
  deploy-staging:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: build
    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4

      - name: Set up SSH key
        env:
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$STAGING_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Copy infra to staging server
        run: |
          rsync -avz --delete infra/ deploy@${{ secrets.STAGING_HOST }}:/srv/househub-infra/

      - name: Deploy with docker compose
        run: |
          ssh deploy@${{ secrets.STAGING_HOST }} " set -e

            cd /srv/househub-infra
            export IMAGE_TAG=${{ needs.build.outputs.image_tag }}
            
            docker compose -f docker-compose.staging.yaml pull
            docker compose -f docker-compose.staging.yaml up -d

            docker image prune -af
          "
